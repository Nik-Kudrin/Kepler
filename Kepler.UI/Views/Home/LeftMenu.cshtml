<div class="sidebar-collapse">
    <ul class="nav" id="main-menu"></ul>
</div>

<li class="main-menu-li-1-lvl" style="display: none">
    <a href="#" class="main-menu-item"><span class="fa arrow"></span></a>
    <div class="main-menu-conf">
        <i class="fa fa-cog" data-toggle="dropdown" aria-hidden="true"></i>
        <ul class="dropdown-menu">
            <li><a href="#" data-toggle="modal" data-target="#crud-modal" data-act="create_proj" data-obj="">Create</a></li>
            <li><a href="#" data-toggle="modal" data-target="#crud-modal" data-act="edit_proj" data-obj="">Edit</a></li>
            <li><a href="#" data-toggle="modal" data-target="#crud-modal" data-act="delete_proj" data-obj="">Delete</a></li>
        </ul>
    </div>
    <ul class="nav nav-second-level"></ul>
</li>

<li class="main-menu-li-2-lvl" style="display: none">
    <a class="left-nav-link main-menu-item" href="#" linkUrl="@Url.Action("PartialBranchView")" linkBranch="master"></a>
    <div class="main-menu-conf">
        <i class="fa fa-cog" data-toggle="dropdown" aria-hidden="true"></i>
        <ul class="dropdown-menu">
            <li><a href="#" data-toggle="modal" data-target="#crud-modal" data-content="create_branch" data-obj="">Create</a></li>
            <li><a href="#" data-toggle="modal" data-target="#crud-modal" data-content="edit_branch" data-obj="">Edit</a></li>
            <li><a href="#" data-toggle="modal" data-target="#crud-modal" data-content="delete_branch" data-obj="">Delete</a></li>
        </ul>
    </div>
</li>

<script type="text/javascript">
    //
    // Load left menu
    //
    loadLeftMenu();

    function loadLeftMenu() {
        $('.sidebar-collapse').empty().append('<ul class="nav" id="main-menu"></ul>');
        $.ajax({
            url: KeplerServiceUrl + 'GetProjects',
            type: 'GET',
            success: function (data) {
                $.each(data, function (objNum) {
                    if (data[objNum]) {
                        $('.main-menu-li-1-lvl').clone(true, true).appendTo('#main-menu').removeClass('main-menu-li-1-lvl').show();
                        $('#main-menu > li:last > .main-menu-item').prepend(data[objNum].Name);
                        $('#main-menu > li:last .dropdown-menu a').attr('data-obj', data[objNum].Id);

                        $.each(data, function (subObjNum) {
                            if (data[objNum].Branches[subObjNum]) {
                                $('.main-menu-li-2-lvl').clone(true, true).appendTo('#main-menu > li:last .nav-second-level').removeClass('main-menu-li-2-lvl').show();
                                $('#main-menu > li:last .nav-second-level > li:last > a').prepend(data[objNum].Branches[subObjNum].Value.Name);
                                $('#main-menu > li:last .nav-second-level > li:last .dropdown-menu a').attr('data-obj', data[objNum].Branches[subObjNum].Value.Id);
                            }
                        });
                    }
                });
                $('#main-menu').metisMenu();
            }
        });
    }

    //
    // Load content by click in left menu
    //
    $('.left-nav-link').click(function () {
        var linkUrl = $(this).attr('linkUrl');

        $.ajax({
            url: linkUrl,
            type: 'GET',
            success: function (data) {
                $('#page-inner').html(data);
            }
        });
    });

    //
    // Popup switch for actions in left menu(Create project, edit branch, etc.)
    //
    var obj_act = ""; // Variable with action, to do with project or branch. Left menu.

    $(document).on('click', '.main-menu-conf a', function (e) {
        switch ($(this).attr('data-act')) {
            case 'create_proj':
                obj_act = "CreateProject";
                $('.modal-title').text('Create project');
                $('.modal-body').empty().append('<div class="form-group"><label>Name</label><input class="form-control" name="name" type="text"></div>' +
                    '<div class="alert alert-warning"></div>');
                $('.modal-footer').show().empty().append('<button type="submit" class="btn btn-success">Save</button>');
                break;
        }
    });

    //
    // Ajax call for modal popup (Create project, edit branch, etc.)
    //

    function modal_ajax_call() {
        var url_parameters = obj_act + '?' + $('#modal_form').serialize();
        $.ajax({
            type: 'GET',
            url: KeplerServiceUrl + url_parameters,
            success: function (data) {
                $('#modal_form .alert-warning').hide();
                $('#crud-modal button.close').click();
                loadLeftMenu();
            },
            error: function (xhr) {
                $('#modal_form .alert-warning').show().text(xhr.responseText);
            }
        });
    }

</script>